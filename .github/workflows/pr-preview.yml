name: PR Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# Prevent concurrent deployments to the same PR environment
concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'ratings-reviews-poc' }}
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}
  SERVICE_NAME: ratings-reviews

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
    - name: Debug workflow info
      run: |
        echo "Workflow run: ${{ github.run_id }}"
        echo "Event: ${{ github.event_name }}"
        echo "PR number: ${{ github.event.pull_request.number }}"
        echo "Ref: ${{ github.ref }}"
        echo "Head ref: ${{ github.head_ref }}"
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate PR environment name
      id: env
      run: |
        PR_NUMBER=${{ github.event.number }}
        BRANCH_NAME=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/^-\+\|-\+$//g' | cut -c1-20)
        ENV_NAME="pr-${PR_NUMBER}-${BRANCH_NAME}"
        # Ensure service names comply with Cloud Run naming requirements (lowercase, alphanumeric and hyphens, max 63 chars)
        BACKEND_SERVICE=$(echo "${SERVICE_NAME}-backend-${ENV_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-63)
        FRONTEND_SERVICE=$(echo "${SERVICE_NAME}-frontend-${ENV_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-63)
        echo "Environment name: ${ENV_NAME}"
        echo "Backend service: ${BACKEND_SERVICE}"
        echo "Frontend service: ${FRONTEND_SERVICE}"
        echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT
        echo "backend_service=${BACKEND_SERVICE}" >> $GITHUB_OUTPUT
        echo "frontend_service=${FRONTEND_SERVICE}" >> $GITHUB_OUTPUT

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure gcloud project
      run: |
        echo "Project ID: ${{ env.PROJECT_ID }}"
        echo "Region: ${{ env.REGION }}"
        gcloud config set project ${{ env.PROJECT_ID }}
        gcloud config set run/region ${{ env.REGION }}
        gcloud config list

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    - name: Build and test backend
      run: |
        cd backend
        npm ci
        npm run build
        npm test || echo "No tests configured for backend"

    - name: Build and test frontend
      run: |
        cd frontend
        npm ci
        npm run build
        npm test || echo "No tests configured for frontend"

    - name: Build backend Docker image
      run: |
        cd backend
        docker build -t gcr.io/${{ env.PROJECT_ID }}/backend:${{ steps.env.outputs.env_name }} .

    - name: Build frontend Docker image
      run: |
        cd frontend
        docker build -t gcr.io/${{ env.PROJECT_ID }}/frontend:${{ steps.env.outputs.env_name }} .

    - name: Push Docker images
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/backend:${{ steps.env.outputs.env_name }}
        docker push gcr.io/${{ env.PROJECT_ID }}/frontend:${{ steps.env.outputs.env_name }}

    - name: Deploy backend to Cloud Run
      run: |
        gcloud run deploy ${{ steps.env.outputs.backend_service }} \
          --image gcr.io/${{ env.PROJECT_ID }}/backend:${{ steps.env.outputs.env_name }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars "NODE_ENV=preview" \
          --timeout 300

    - name: Deploy frontend to Cloud Run
      run: |
        gcloud run deploy ${{ steps.env.outputs.frontend_service }} \
          --image gcr.io/${{ env.PROJECT_ID }}/frontend:${{ steps.env.outputs.env_name }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars "NODE_ENV=preview" \
          --timeout 300

    - name: Ensure services are publicly accessible
      run: |
        # Wait for services to be fully deployed
        sleep 5
        
        # Remove any authentication requirements and explicitly set public access
        echo "Setting backend service to public..."
        gcloud run services add-iam-policy-binding ${{ steps.env.outputs.backend_service }} \
          --region=${{ env.REGION }} \
          --member="allUsers" \
          --role="roles/run.invoker" \
          --platform=managed
        
        echo "Setting frontend service to public..."
        gcloud run services add-iam-policy-binding ${{ steps.env.outputs.frontend_service }} \
          --region=${{ env.REGION }} \
          --member="allUsers" \
          --role="roles/run.invoker" \
          --platform=managed
        
        # Verify the IAM policies
        echo "Verifying backend IAM policy..."
        gcloud run services get-iam-policy ${{ steps.env.outputs.backend_service }} --region=${{ env.REGION }}
        
        echo "Verifying frontend IAM policy..."
        gcloud run services get-iam-policy ${{ steps.env.outputs.frontend_service }} --region=${{ env.REGION }}

    - name: Get service URLs
      id: urls
      run: |
        BACKEND_URL=$(gcloud run services describe ${{ steps.env.outputs.backend_service }} --region=${{ env.REGION }} --format='value(status.url)')
        FRONTEND_URL=$(gcloud run services describe ${{ steps.env.outputs.frontend_service }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
        echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT

    - name: Update frontend with backend URL
      run: |
        # Update the frontend to use the correct backend URL
        gcloud run services update ${{ steps.env.outputs.frontend_service }} \
          --region ${{ env.REGION }} \
          --set-env-vars "BACKEND_URL=${{ steps.urls.outputs.backend_url }}"

    - name: Test deployments
      run: |
        echo "Testing backend health check..."
        curl -f ${{ steps.urls.outputs.backend_url }}/health || exit 1
        
        echo "Testing frontend health check..."
        curl -f ${{ steps.urls.outputs.frontend_url }}/health || exit 1
        
        echo "Testing backend API..."
        curl -f ${{ steps.urls.outputs.backend_url }}/api/ratings || exit 1

    - name: Comment PR with preview URLs
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## ðŸš€ Preview Deployment Ready!
          
          Your PR has been deployed to preview environments:
          
          | Service | URL | Status |
          |---------|-----|--------|
          | ðŸŽ¯ **Frontend** | [${{ steps.urls.outputs.frontend_url }}](${{ steps.urls.outputs.frontend_url }}) | âœ… |
          | ðŸ”§ **Backend API** | [${{ steps.urls.outputs.backend_url }}](${{ steps.urls.outputs.backend_url }}) | âœ… |
          
          ### Quick Links:
          - ðŸŒ [Preview App](${{ steps.urls.outputs.frontend_url }})
          - ðŸ“Š [Backend Health](${{ steps.urls.outputs.backend_url }}/health)
          - ðŸ” [API Ratings](${{ steps.urls.outputs.backend_url }}/api/ratings)
          
          ### Environment Details:
          - **Environment**: \`${{ steps.env.outputs.env_name }}\`
          - **Region**: \`${{ env.REGION }}\`
          - **Auto-cleanup**: Environments are automatically cleaned up when PR is closed
          
          > ðŸ’¡ **Note**: This is a POC deployment using only GCP free tier services (Cloud Run).`;
          
          // Find existing comment to update or create new one
          const comments = await github.rest.issues.listComments({
            owner,
            repo,
            issue_number: pr_number,
          });
          
          const existingComment = comments.data.find(comment => 
            comment.body.includes('Preview Deployment Ready!')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: comment
            });
          }